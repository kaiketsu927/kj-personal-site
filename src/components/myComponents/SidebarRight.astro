---
import { mySkills } from "~/data/myData";
// 在伺服器端就先跑出categories變數 //使用Set去重複
const categories = ["All", ...new Set(mySkills.map((mySkill)=> mySkill.category))];
---
<!--hidden會在mobile-first模式下隱藏此區塊  lg:block是直到tablet等級的螢幕大小才會呈現區塊(block
) -->
<aside class="hidden w-80 border-l bg-gray-50 flex-col h-full lg:flex overflow-hidden">
    
    <div class="px-4 py-3 flex items-center justify-between bg-gray-50 z-20 sticky top-0 border-b border-gray-200">
        
        <h3 class="font-bold text-gray-500 text-base">聯絡人</h3>
        
        <div class="flex items-center gap-1">
            
            <button 
                id="filter-toggle-btn" 
                class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors relative group"
                title="篩選分類"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>

                <span id="filter-active-dot" class="hidden absolute top-1.5 right-1.5 w-2 h-2 bg-blue-500 rounded-full border border-gray-50"></span>
            </button>

            <button class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                </svg>
            </button>
        </div>
    </div>
    
    <div id="filter-menu" class="hidden bg-white border-b border-gray-100 shadow-inner">
        <div class="p-3 flex flex-wrap gap-2">
            {categories.map(category => (
                <button 
                    class="filter-btn px-3 py-1 text-xs rounded-full border border-gray-200 bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-colors"
                    data-filter={category}
                >
                    {category}
                </button>
            ))}
        </div>
    </div>
    
    <div class="flex-1 overflow-y-auto p-4 space-y-2">
    {   
        // skill-contact 把整類的div取名(之後統一由js/ts做動態控制)
        // 單一個區塊內呈水平排列

        //重要: DOM只認string, 所以遇到string[]要先用Json序列化成一個string 之後要再反序列化
        //一般來說自定義的class name要在前面冠上data-來辨識
        mySkills.map((skill)=>(
            <div class="skill-contact flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors relative group"
            data-skill-name={skill.name} data-skill-status-messages={JSON.stringify(skill.statusMessage)} data-skill-category={skill.category}>

                {/* 圖片跟綠點塞在同一個(圓形)區塊 */}
                <div class="relative">
                    <img 
                        src={skill.logo_path} 
                        alt={skill.name} 
                        class="w-10 h-10 rounded-full bg-white border border-gray-200 object-cover" 
                    />
                    {
                        //根據familiar動態渲染
                        skill.familiar === 'online' ?
                        //  Online -> 產生綠燈
                        <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-green-500"></div> :
                        skill.familiar === 'offline' ?
                        // offline -> 無燈(或產生背景色的燈)
                        <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-gray-400"></div>:
                        // 其他文字敘述 -> 產生上次接觸時間
                        <span class="absolute -bottom-2 right-0 text-[10px] bg-gray-100 px-1 rounded text-gray-500 border border-gray-200">
                            {skill.familiar}
                        </span>

                    }
                </div>
                {/* logo右方的使用者名稱區塊 */} 
                <div class="flex flex-col">
                    <span class="font-medium text-gray-900">{skill.name}</span>
                    <span class="text-xs text-gray-400">{skill.category}</span>
                </div>
                
            </div>
        ))  
        
    }
    </div>
</aside>

<script>
	//<script>只在brower端才會執行 到這邊已經是所有的靜態ui都產生了
	// 所以只能操作DOM元素 要跟skill串接 就只能靠之前留在屬性上的資訊
	// CSS-Selector 以.識別為class , 以#識別為ID
	const allSkills  = document.querySelectorAll('.skill-contact');

	// 到時候在MyLayout.astro會集中管理script 所以拿得到ChatWindow的DOM
	// 在處理DOM的時候常用斷言(告訴TS你確保這邊是拿到HTMLElement 而不是null  不然型別標示他是幫你檢查型別 會囉嗦)
	const chatWindow = document.getElementById('chat-window') as HTMLElement;
	const windowName = document.getElementById('chat-title-name') as HTMLElement;
	const windowMessages = document.getElementById('chat-messages') as HTMLElement;

	allSkills.forEach((skillBtn)=>{
		skillBtn.addEventListener('click',()=>{
			const skillName = skillBtn.getAttribute('data-skill-name') || 'Unknown'; 
			const rawSkillStutasMessages = skillBtn.getAttribute('data-skill-status-messages') || '[]';
			
			//如果根本讀不到視窗就無法執行 不加斷言的話可用
			// if(!window || !windowName || !windowMessages) return;

			windowName.innerText = skillName? skillName : 'DefaultSkillName';
			//彈出前先清空
			windowMessages.innerText ='';
			//反序列化message後再改變DOM
			const skillStutasMessages  = JSON.parse(rawSkillStutasMessages) || '[]';
			// windowMessages.innerText = skillStutasMessages? skillStutasMessages : [];
			skillStutasMessages.forEach((message)=>
			{
				const paragraph = document.createElement('div');
				paragraph.classList.add('bg-gray-100', 'p-2', 'rounded', 'mb-2', 'self-start', 'max-w-[80%]');
				paragraph.innerText = message;
				windowMessages.appendChild(paragraph);
			})
			//移除hidden屬性 讓聊天室可以彈出
			chatWindow.classList.remove('hidden');
		})
	})
	
	//  以下為篩選按鈕邏輯
    const toggleBtn = document.getElementById('filter-toggle-btn');
    const filterMenu = document.getElementById('filter-menu');

    const filterBtns = document.querySelectorAll('.filter-btn');
    const activeDot = document.getElementById('filter-active-dot');
    const noResultMsg = document.getElementById('no-result-msg');

    // 點擊放大鏡 -> 展開/收合篩選標籤
    toggleBtn?.addEventListener('click', () => {
        filterMenu?.classList.toggle('hidden');
        toggleBtn.classList.toggle('bg-gray-200');
    });

    // 點擊分類標籤
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetCategory = btn.getAttribute('data-filter');
            let visibleCount = 0;

            filterBtns.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
            });
            btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');

            allSkills.forEach(skill => {
                const el = skill as HTMLElement;
                const category = el.getAttribute('data-skill-category');

                if (targetCategory === 'All' || category === targetCategory) {
                    el.classList.remove('hidden');
                    el.classList.add('flex');
                    visibleCount++;
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                }
            });

            if (noResultMsg) {
                visibleCount === 0 ? noResultMsg.classList.remove('hidden') : noResultMsg.classList.add('hidden');
            }

            // 狀態回饋
            if (targetCategory !== 'All') {
                activeDot?.classList.remove('hidden');
                toggleBtn?.classList.add('text-blue-600');
            } else {
                activeDot?.classList.add('hidden');
                toggleBtn?.classList.remove('text-blue-600');
            }
        });
    });

    if(filterBtns.length > 0) {
        const firstBtn = filterBtns[0] as HTMLElement;
        firstBtn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
        firstBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    }
</script>