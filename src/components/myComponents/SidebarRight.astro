---
import { mySkills } from "~/data/myData";
// åœ¨ä¼ºæœå™¨ç«¯å°±å…ˆè·‘å‡ºcategoriesè®Šæ•¸ //ä½¿ç”¨Setå»é‡è¤‡
const categories = ["All", ...new Set(mySkills.map((mySkill)=> mySkill.category))];
---
<!--hiddenæœƒåœ¨mobile-firstæ¨¡å¼ä¸‹éš±è—æ­¤å€å¡Š  lg:blockæ˜¯ç›´åˆ°tabletç­‰ç´šçš„è¢å¹•å¤§å°æ‰æœƒå‘ˆç¾å€å¡Š(block
) -->
<aside class="hidden w-80 border-l bg-gray-50 flex-col h-full lg:flex overflow-hidden">
    
    <div class="px-4 py-3 flex items-center justify-between bg-gray-50 z-20 sticky top-0 border-b border-gray-200">
        
        <h3 class="font-bold text-gray-500 text-base">è¯çµ¡äºº</h3>
        
        <div class="flex items-center gap-1">
            
            <button 
                id="filter-toggle-btn" 
                class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors relative group"
                title="ç¯©é¸åˆ†é¡"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>

                <span id="filter-active-dot" class="hidden absolute top-1.5 right-1.5 w-2 h-2 bg-blue-500 rounded-full border border-gray-50"></span>
            </button>

            <button class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                </svg>
            </button>
        </div>
    </div>
    
    <div id="filter-menu" class="hidden bg-white border-b border-gray-100 shadow-inner">
        <div class="p-3 flex flex-wrap gap-2">
            {categories.map(category => (
                <button 
                    class="filter-btn px-3 py-1 text-xs rounded-full border border-gray-200 bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-colors"
                    data-filter={category}
                >
                    {category}
                </button>
            ))}
        </div>
    </div>
    
    <div class="flex-1 overflow-y-auto p-4 space-y-2">
    {   
        // skill-contact æŠŠæ•´é¡çš„divå–å(ä¹‹å¾Œçµ±ä¸€ç”±js/tsåšå‹•æ…‹æ§åˆ¶)
        // å–®ä¸€å€‹å€å¡Šå…§å‘ˆæ°´å¹³æ’åˆ—

        //é‡è¦: DOMåªèªstring, æ‰€ä»¥é‡åˆ°string[]è¦å…ˆç”¨Jsonåºåˆ—åŒ–æˆä¸€å€‹string ä¹‹å¾Œè¦å†ååºåˆ—åŒ–
        //ä¸€èˆ¬ä¾†èªªè‡ªå®šç¾©çš„class nameè¦åœ¨å‰é¢å† ä¸Šdata-ä¾†è¾¨è­˜
        mySkills.map((skill)=>(
            <div class="skill-contact flex items-center gap-3 p-2 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors relative group"
            data-skill-name={skill.name} data-skill-status-messages={JSON.stringify(skill.statusMessage)} data-skill-category={skill.category}>

                {/* åœ–ç‰‡è·Ÿç¶ é»å¡åœ¨åŒä¸€å€‹(åœ“å½¢)å€å¡Š */}
                <div class="relative">
                    <img 
                        src={skill.logo_path} 
                        alt={skill.name} 
                        class="w-10 h-10 rounded-full bg-white border border-gray-200 object-cover" 
                    />
                    {
                        //æ ¹æ“šfamiliarå‹•æ…‹æ¸²æŸ“
                        skill.familiar === 'online' ?
                        //  Online -> ç”¢ç”Ÿç¶ ç‡ˆ
                        <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-green-500"></div> :
                        skill.familiar === 'offline' ?
                        // offline -> ç„¡ç‡ˆ(æˆ–ç”¢ç”ŸèƒŒæ™¯è‰²çš„ç‡ˆ)
                        <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-gray-400"></div>:
                        // å…¶ä»–æ–‡å­—æ•˜è¿° -> ç”¢ç”Ÿä¸Šæ¬¡æ¥è§¸æ™‚é–“
                        <span class="absolute -bottom-2 right-0 text-[10px] bg-gray-100 px-1 rounded text-gray-500 border border-gray-200">
                            {skill.familiar}
                        </span>

                    }
                </div>
                {/* logoå³æ–¹çš„ä½¿ç”¨è€…åç¨±å€å¡Š */} 
                <div class="flex flex-col">
                    <span class="font-medium text-gray-900">{skill.name}</span>
                    <span class="text-xs text-gray-400">{skill.category}</span>
                </div>
                
            </div>
        ))  
        
    }
    </div>
</aside>

<script>
	//<script>åªåœ¨browerç«¯æ‰æœƒåŸ·è¡Œ åˆ°é€™é‚Šå·²ç¶“æ˜¯æ‰€æœ‰çš„éœæ…‹uiéƒ½ç”¢ç”Ÿäº†
	// æ‰€ä»¥åªèƒ½æ“ä½œDOMå…ƒç´  è¦è·Ÿskillä¸²æ¥ å°±åªèƒ½é ä¹‹å‰ç•™åœ¨å±¬æ€§ä¸Šçš„è³‡è¨Š
	// CSS-Selector ä»¥.è­˜åˆ¥ç‚ºclass , ä»¥#è­˜åˆ¥ç‚ºID
	const allSkills  = document.querySelectorAll('.skill-contact');

	// åˆ°æ™‚å€™åœ¨MyLayout.astroæœƒé›†ä¸­ç®¡ç†script æ‰€ä»¥æ‹¿å¾—åˆ°ChatWindowçš„DOM
	// åœ¨è™•ç†DOMçš„æ™‚å€™å¸¸ç”¨æ–·è¨€(å‘Šè¨´TSä½ ç¢ºä¿é€™é‚Šæ˜¯æ‹¿åˆ°HTMLElement è€Œä¸æ˜¯null  ä¸ç„¶å‹åˆ¥æ¨™ç¤ºä»–æ˜¯å¹«ä½ æª¢æŸ¥å‹åˆ¥ æœƒå›‰å—¦)
	const chatWindow = document.getElementById('chat-window') as HTMLElement;
	const windowName = document.getElementById('chat-title-name') as HTMLElement;
	const windowMessages = document.getElementById('chat-messages') as HTMLElement;

	allSkills.forEach((skillBtn)=>{
        skillBtn.addEventListener('click',()=>{
            const skillName = skillBtn.getAttribute('data-skill-name') || 'Unknown'; 
            // é€™è£¡å·²ç¶“æœ‰ || '[]' ä¿è­·äº†ï¼Œæ‰€ä»¥ rawSkillStutasMessages ä¸€å®šæ˜¯ JSON å­—ä¸²
            const rawSkillStutasMessages = skillBtn.getAttribute('data-skill-status-messages') || '[]';
            
            windowName.innerText = skillName? skillName : 'DefaultSkillName';
            windowMessages.innerText ='';

            // ğŸ”¥ ä¿®æ­£ 1 & 2ï¼š
            // ç§»é™¤å¾Œé¢çš„ || '[]' (é‚£æ˜¯å­—ä¸²ï¼Œæœƒå°è‡´å‹åˆ¥éŒ¯èª¤)
            // åŠ ä¸Š "as string[]" å‘Šè¨´ TS é€™è£¡é¢è£çš„æ˜¯å­—ä¸²é™£åˆ—
            const skillStutasMessages = JSON.parse(rawSkillStutasMessages) as string[];
            
            // é€™æ¨£ TS å°±çŸ¥é“ message å¿…å®šæ˜¯ stringï¼Œä¸æœƒå ±éŒ¯äº†
            skillStutasMessages.forEach((message) => {
                const paragraph = document.createElement('div');
                paragraph.classList.add('bg-gray-100', 'p-2', 'rounded', 'mb-2', 'self-start', 'max-w-[80%]');
                paragraph.innerText = message;
                windowMessages.appendChild(paragraph);
            });

            chatWindow.classList.remove('hidden');
        })
    })
	
	//  ä»¥ä¸‹ç‚ºç¯©é¸æŒ‰éˆ•é‚è¼¯
    const toggleBtn = document.getElementById('filter-toggle-btn');
    const filterMenu = document.getElementById('filter-menu');

    const filterBtns = document.querySelectorAll('.filter-btn');
    const activeDot = document.getElementById('filter-active-dot');
    const noResultMsg = document.getElementById('no-result-msg');

    // é»æ“Šæ”¾å¤§é¡ -> å±•é–‹/æ”¶åˆç¯©é¸æ¨™ç±¤
    toggleBtn?.addEventListener('click', () => {
        filterMenu?.classList.toggle('hidden');
        toggleBtn.classList.toggle('bg-gray-200');
    });

    // é»æ“Šåˆ†é¡æ¨™ç±¤
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetCategory = btn.getAttribute('data-filter');
            let visibleCount = 0;

            filterBtns.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
            });
            btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');

            allSkills.forEach(skill => {
                const el = skill as HTMLElement;
                const category = el.getAttribute('data-skill-category');

                if (targetCategory === 'All' || category === targetCategory) {
                    el.classList.remove('hidden');
                    el.classList.add('flex');
                    visibleCount++;
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                }
            });

            if (noResultMsg) {
                if (visibleCount === 0) {
                    noResultMsg.classList.remove('hidden');
                } else {
                    noResultMsg.classList.add('hidden');
                }
            }
            // ç‹€æ…‹å›é¥‹
            if (targetCategory !== 'All') {
                activeDot?.classList.remove('hidden');
                toggleBtn?.classList.add('text-blue-600');
            } else {
                activeDot?.classList.add('hidden');
                toggleBtn?.classList.remove('text-blue-600');
            }
        });
    });

    if(filterBtns.length > 0) {
        const firstBtn = filterBtns[0] as HTMLElement;
        firstBtn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
        firstBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    }
</script>